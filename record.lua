local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer

print("üéØ Enhanced SkipWave Test - With Server Response")
print("="..string.rep("=", 50))

-- Bi·∫øn ƒë·ªÉ track
local skipCount = 0
local serverResponses = {}

-- L·∫•y wave hi·ªán t·∫°i
local function getCurrentWave()
    local playerGui = player:FindFirstChildOfClass("PlayerGui")
    if not playerGui then return "Unknown" end
    
    local interface = playerGui:FindFirstChild("Interface")
    if not interface then return "Unknown" end
    
    local gameInfoBar = interface:FindFirstChild("GameInfoBar")
    if not gameInfoBar then return "Unknown" end
    
    return gameInfoBar.Wave.WaveText.Text
end

-- L·∫•y th·ªùi gian hi·ªán t·∫°i
local function getCurrentTime()
    local playerGui = player:FindFirstChildOfClass("PlayerGui")
    if not playerGui then return "Unknown" end
    
    local interface = playerGui:FindFirstChild("Interface")
    if not interface then return "Unknown" end
    
    local gameInfoBar = interface:FindFirstChild("GameInfoBar")
    if not gameInfoBar then return "Unknown" end
    
    return gameInfoBar.TimeLeft.TimeLeftText.Text
end

-- Chuy·ªÉn ƒë·ªïi time string th√†nh number
local function convertTimeToNumber(timeStr)
    if not timeStr then return nil end
    local mins, secs = timeStr:match("(%d+):(%d+)")
    if mins and secs then
        return tonumber(mins) * 100 + tonumber(secs)
    end
    return nil
end

-- X·ª≠ l√Ω skip wave v·ªõi server response
local function handleSkipWave(method, args, serverResponse)
    skipCount = skipCount + 1
    local wave = getCurrentWave()
    local time = getCurrentTime()
    local timeNumber = convertTimeToNumber(time)
    
    print(string.format("üöÄ [%s] SKIP WAVE #%d", method, skipCount))
    print(string.format("   üìä Wave: %s | Time: %s (%s)", wave, time, timeNumber or "N/A"))
    print(string.format("   üìã Args: %s", HttpService:JSONEncode(args)))
    
    -- Hi·ªÉn th·ªã server response n·∫øu c√≥
    if serverResponse ~= nil then
        print(string.format("   üåê Server Response: %s", tostring(serverResponse)))
        print(string.format("   üì° Response Type: %s", type(serverResponse)))
        
        -- N·∫øu response l√† table, hi·ªÉn th·ªã chi ti·∫øt
        if type(serverResponse) == "table" then
            local success, jsonStr = pcall(HttpService.JSONEncode, HttpService, serverResponse)
            if success then
                print(string.format("   üì¶ Response JSON: %s", jsonStr))
            end
        end
        
        -- L∆∞u response ƒë·ªÉ ph√¢n t√≠ch
        table.insert(serverResponses, {
            count = skipCount,
            wave = wave,
            time = time,
            timeNumber = timeNumber,
            args = args,
            response = serverResponse,
            timestamp = tick()
        })
    else
        print("   üåê Server Response: (No response - FireServer)")
    end
    
    print(string.format("   üïê Timestamp: %s", os.date("%H:%M:%S")))
    print("")
    
    -- T·∫°o command format TDX v·ªõi th√¥ng tin chi ti·∫øt
    local command = "TDX:skipWave()"
    print(string.format("   üíæ Command: %s", command))
    
    -- Th√™m th√¥ng tin cho macro format
    if timeNumber then
        print(string.format("   üìù Macro Format: SkipWhen=%s, SkipWave=%s", wave, timeNumber))
    end
    print("")
end

--==============================================================================
--=                         HOOK FIRESERVER                                    =
--==============================================================================

print("üîß Thi·∫øt l·∫≠p Hook cho FireServer (RemoteEvent)")
if hookfunction then
    pcall(function()
        local oldFireServer = hookfunction(Instance.new("RemoteEvent").FireServer, function(self, ...)
            -- Ch·ªâ x·ª≠ l√Ω SkipWaveVoteCast
            if self.Name == "SkipWaveVoteCast" then
                local args = {...}
                handleSkipWave("FireServer-Hook", args, nil) -- FireServer kh√¥ng c√≥ return value
            end
            
            -- G·ªçi original function
            return oldFireServer(self, ...)
        end)
        print("‚úÖ FireServer Hook - TH√ÄNH C√îNG")
    end)
else
    print("‚ùå hookfunction kh√¥ng kh·∫£ d·ª•ng cho FireServer")
end

--==============================================================================
--=                        HOOK INVOKESERVER                                   =
--==============================================================================

print("üîß Thi·∫øt l·∫≠p Hook cho InvokeServer (RemoteFunction)")
if hookfunction then
    pcall(function()
        local oldInvokeServer = hookfunction(Instance.new("RemoteFunction").InvokeServer, function(self, ...)
            -- Ch·ªâ x·ª≠ l√Ω n·∫øu c√≥ RemoteFunction t√™n SkipWaveVoteCast (√≠t kh·∫£ nƒÉng)
            if self.Name == "SkipWaveVoteCast" then
                local args = {...}
                local result = oldInvokeServer(self, ...)
                handleSkipWave("InvokeServer-Hook", args, result)
                return result
            end
            
            -- G·ªçi original function cho c√°c remote kh√°c
            return oldInvokeServer(self, ...)
        end)
        print("‚úÖ InvokeServer Hook - TH√ÄNH C√îNG")
    end)
else
    print("‚ùå hookfunction kh√¥ng kh·∫£ d·ª•ng cho InvokeServer")
end

--==============================================================================
--=                       HOOK METAMETHOD                                      =
--==============================================================================

print("üîß Thi·∫øt l·∫≠p Hook cho __namecall")
if hookmetamethod and checkcaller then
    pcall(function()
        local oldNamecall
        oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
            -- B·ªè qua n·∫øu l√† internal call
            if checkcaller() then return oldNamecall(self, ...) end
            
            local method = getnamecallmethod()
            
            -- X·ª≠ l√Ω FireServer
            if method == "FireServer" and self.Name == "SkipWaveVoteCast" then
                local args = {...}
                handleSkipWave("Namecall-FireServer", args, nil)
            
            -- X·ª≠ l√Ω InvokeServer (n·∫øu c√≥)
            elseif method == "InvokeServer" and self.Name == "SkipWaveVoteCast" then
                local args = {...}
                local result = oldNamecall(self, ...)
                handleSkipWave("Namecall-InvokeServer", args, result)
                return result
            end
            
            -- G·ªçi original function
            return oldNamecall(self, ...)
        end)
        print("‚úÖ Namecall Hook - TH√ÄNH C√îNG")
    end)
else
    print("‚ùå hookmetamethod ho·∫∑c checkcaller kh√¥ng kh·∫£ d·ª•ng")
end

--==============================================================================
--=                      HOOK CLIENT EVENTS                                    =
--==============================================================================

print("üîß Thi·∫øt l·∫≠p Hook cho Client Events")
pcall(function()
    -- Hook s·ª± ki·ªán c√≥ th·ªÉ li√™n quan ƒë·∫øn skip wave
    local remotes = ReplicatedStorage:FindFirstChild("Remotes")
    if remotes then
        -- T√¨m c√°c event c√≥ th·ªÉ li√™n quan ƒë·∫øn skip wave response
        for _, remote in pairs(remotes:GetChildren()) do
            if remote:IsA("RemoteEvent") and 
               (string.find(remote.Name:lower(), "skip") or 
                string.find(remote.Name:lower(), "wave") or
                string.find(remote.Name:lower(), "vote")) then
                
                pcall(function()
                    remote.OnClientEvent:Connect(function(...)
                        local args = {...}
                        print(string.format("üì° Client Event [%s]: %s", 
                              remote.Name, 
                              HttpService:JSONEncode(args)))
                        
                        -- L∆∞u event data
                        table.insert(serverResponses, {
                            type = "ClientEvent",
                            remoteName = remote.Name,
                            data = args,
                            timestamp = tick()
                        })
                    end)
                    print(string.format("‚úÖ ƒê√£ hook client event: %s", remote.Name))
                end)
            end
        end
    end
end)

--==============================================================================
--=                         MANUAL TEST FUNCTIONS                              =
--==============================================================================

-- Test function v·ªõi detailed logging
_G.testSkipWave = function()
    print("")
    print("üß™ MANUAL TEST: G·ª≠i SkipWaveVoteCast...")
    print("="..string.rep("-", 30))
    
    local remotes = ReplicatedStorage:FindFirstChild("Remotes")
    if remotes then
        local skipRemote = remotes:FindFirstChild("SkipWaveVoteCast")
        if skipRemote then
            local beforeWave = getCurrentWave()
            local beforeTime = getCurrentTime()
            
            print(string.format("üìä Tr∆∞·ªõc khi skip - Wave: %s, Time: %s", beforeWave, beforeTime))
            
            -- Test v·ªõi vote = true
            print("üì§ G·ª≠i vote = true...")
            skipRemote:FireServer(true)
            
            -- Ch·ªù m·ªôt ch√∫t ƒë·ªÉ xem response
            task.wait(0.5)
            
            local afterWave = getCurrentWave()
            local afterTime = getCurrentTime()
            print(string.format("üìä Sau khi skip - Wave: %s, Time: %s", afterWave, afterTime))
            
            print("‚úÖ Manual test ho√†n th√†nh!")
        else
            print("‚ùå SkipWaveVoteCast remote kh√¥ng t√¨m th·∫•y")
        end
    else
        print("‚ùå Remotes folder kh√¥ng t√¨m th·∫•y")
    end
    print("")
end

-- Function ƒë·ªÉ xem t·∫•t c·∫£ responses ƒë√£ thu th·∫≠p
_G.showResponses = function()
    print("")
    print("üìä T·∫§T C·∫¢ SERVER RESPONSES:")
    print("="..string.rep("=", 40))
    
    if #serverResponses == 0 then
        print("‚ùå Ch∆∞a c√≥ response n√†o ƒë∆∞·ª£c ghi nh·∫≠n")
        return
    end
    
    for i, response in ipairs(serverResponses) do
        print(string.format("üì¶ Response #%d:", i))
        print(string.format("   Count: %s", response.count or "N/A"))
        print(string.format("   Wave: %s", response.wave or "N/A"))
        print(string.format("   Time: %s", response.time or "N/A"))
        print(string.format("   Type: %s", response.type or "Skip"))
        print(string.format("   Data: %s", HttpService:JSONEncode(response.response or response.data)))
        print("")
    end
end

-- Function ƒë·ªÉ clear responses
_G.clearResponses = function()
    serverResponses = {}
    skipCount = 0
    print("üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£ responses v√† reset counter")
end

--==============================================================================
--=                         REMOTE ANALYSIS                                    =
--==============================================================================

print("üîç Ph√¢n t√≠ch RemoteEvents v√† RemoteFunctions...")
local remotes = ReplicatedStorage:FindFirstChild("Remotes")
if remotes then
    local skipRelated = {}
    for _, remote in pairs(remotes:GetChildren()) do
        local name = remote.Name:lower()
        if string.find(name, "skip") or string.find(name, "wave") or string.find(name, "vote") then
            table.insert(skipRelated, {
                Name = remote.Name,
                Type = remote.ClassName
            })
        end
    end
    
    if #skipRelated > 0 then
        print("üéØ T√¨m th·∫•y c√°c remote li√™n quan ƒë·∫øn skip/wave/vote:")
        for _, remote in ipairs(skipRelated) do
            print(string.format("   üì° %s (%s)", remote.Name, remote.Type))
        end
    else
        print("‚ùå Kh√¥ng t√¨m th·∫•y remote n√†o li√™n quan ƒë·∫øn skip/wave/vote")
    end
else
    print("‚ùå Kh√¥ng t√¨m th·∫•y Remotes folder")
end

print("="..string.rep("=", 50))
print("‚úÖ Enhanced SkipWave Test ƒë√£ s·∫µn s√†ng!")
print("üéÆ Commands:")
print("   _G.testSkipWave() - Test manual")
print("   _G.showResponses() - Xem t·∫•t c·∫£ responses")
print("   _G.clearResponses() - Clear data")
print("üìä Script s·∫Ω hi·ªÉn th·ªã chi ti·∫øt server response khi b·∫Øt ƒë∆∞·ª£c skip wave")
print("")