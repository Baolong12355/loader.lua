-- C·∫•u h√¨nh
local WEBHOOK_URL = "https://discord.com/api/webhooks/972059328276201492/DPHtxfsIldI5lND2dYUbA8WIZwp4NLYsPDG1Sy6-MKV9YMgV8OohcTf-00SdLmyMpMFC"
local XP_LIMIT = 10000
local SAVE_FILE = "BattlePassProgress.txt"

-- Danh s√°ch BattlePass
local BATTLE_PASSES = {
    {remote = "TB", display = "TOWER BATTLES"},
    {remote = "HW24", display = "HALLOWEEN 2024"},
    {remote = "XMAS24", display = "CHRISTMAS 2024"}
}

-- Kh·ªüi t·∫°o d·ªãch v·ª•
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

-- Bi·∫øn l∆∞u tr·ªØ
local progress = {}
local currentBP = nil
local lastXP = 0
local lastLevel = 0
local isFirstCheck = true

-- ========== H·ªÜ TH·ªêNG L∆ØU FILE ========== --
local function saveProgress()
    local data = {}
    for _, bp in ipairs(BATTLE_PASSES) do
        data[bp.remote] = progress[bp.remote] or 0
    end
    writefile(SAVE_FILE, HttpService:JSONEncode(data))
end

local function loadProgress()
    if isfile(SAVE_FILE) then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile(SAVE_FILE))
        end)
        if success then
            for _, bp in ipairs(BATTLE_PASSES) do
                progress[bp.remote] = data[bp.remote] or 0
            end
            return
        end
    end
    
    -- Kh·ªüi t·∫°o m·ªõi
    for _, bp in ipairs(BATTLE_PASSES) do
        progress[bp.remote] = 0
    end
end

-- ========== H·ªÜ TH·ªêNG DISCORD ========== --
local function sendToDiscord(message)
    local data = {
        ["content"] = message,
        ["username"] = "BP Tracker",
        ["avatar_url"] = "https://i.imgur.com/Lyq5mJO.png"
    }
    
    pcall(function()
        HttpService:PostAsync(WEBHOOK_URL, HttpService:JSONEncode(data))
    end)
end

-- ========== H·ªÜ TH·ªêNG THEO D√ïI ========== --
local function getCurrentXP()
    local success, xpText = pcall(function()
        return LocalPlayer.PlayerGui.GUI.BattlePass.BattlePassDetails.LevelInfo.XP.TextLabel.Text
    end)
    return (success and tonumber(xpText:match("%d+"))) or 0
end

local function getCurrentLevel()
    local success, levelText = pcall(function()
        return LocalPlayer.PlayerGui.Model.GUI.BattlePass.BattlePassDetails.LevelInfo.Current.TextLabel.Text
    end)
    return (success and tonumber(levelText:match("%d+"))) or 0
end

local function getCurrentBattlePass()
    local success, displayName = pcall(function()
        return LocalPlayer.PlayerGui.GUI.BattlePass.BattlePassDetails.PreviewInfo.DisplayName.Text
    end)
    if success then
        for _, bp in ipairs(BATTLE_PASSES) do
            if bp.display == displayName then
                return bp.remote, bp.display
            end
        end
    end
    return nil, nil
end

-- ========== H·ªÜ TH·ªêNG ƒê·ªîI BATTLEPASS ========== --
local function activateBattlePass(bpName)
    local network = ReplicatedStorage:FindFirstChild("Network")
    if not network then return false end
    
    local remote = network:FindFirstChild("BattlePassRequestActivate")
    if not remote then return false end
    
    local success, result = pcall(function()
        return remote:InvokeServer(bpName)
    end)
    
    return success and result or false
end

-- ========== H·ªÜ TH·ªêNG T·ª∞ ƒê·ªòNG ========== --
local function getNextBattlePass()
    for _, bp in ipairs(BATTLE_PASSES) do
        if progress[bp.remote] < XP_LIMIT then
            return bp.remote, bp.display
        end
    end
    return nil, nil
end

local function allMaxed()
    for _, bp in ipairs(BATTLE_PASSES) do
        if progress[bp.remote] < XP_LIMIT then
            return false
        end
    end
    return true
end

local function checkProgress()
    local currentXP = getCurrentXP()
    local currentLevel = getCurrentLevel()
    local bpRemote, bpDisplay = getCurrentBattlePass()
    
    if not bpRemote then return end
    
    -- B·ªè qua l·∫ßn ki·ªÉm tra ƒë·∫ßu ti√™n (tr√°nh t√≠nh XP c∆° b·∫£n)
    if isFirstCheck then
        lastXP = currentXP
        lastLevel = currentLevel
        isFirstCheck = false
        return
    end
    
    -- Ch·ªâ x·ª≠ l√Ω khi XP thay ƒë·ªïi
    if currentXP ~= lastXP then
        local xpGained = currentXP - lastXP
        
        if xpGained > 0 then
            progress[bpRemote] = math.min(progress[bpRemote] + xpGained, XP_LIMIT)
            saveProgress()
            
            -- G·ª≠i th√¥ng b√°o Discord
            local message = string.format(
                "üéØ %s: +%d XP (T·ªïng: %d/%d)\nLevel: %d",
                bpDisplay, xpGained, progress[bpRemote], XP_LIMIT, currentLevel
            )
            sendToDiscord(message)
            
            -- Ki·ªÉm tra ho√†n th√†nh
            if progress[bpRemote] >= XP_LIMIT then
                sendToDiscord(string.format("‚úÖ ƒê√£ ƒë·∫°t ƒë·ªß %d XP cho %s!", XP_LIMIT, bpDisplay))
                
                -- Chuy·ªÉn sang BattlePass ti·∫øp theo
                local nextBP, nextDisplay = getNextBattlePass()
                if nextBP then
                    if activateBattlePass(nextBP) then
                        sendToDiscord("üîÑ ƒê√£ chuy·ªÉn sang: "..nextDisplay)
                        -- Reset b·ªô ƒë·∫øm
                        isFirstCheck = true
                    end
                else
                    sendToDiscord("üèÜ ƒê√É HO√ÄN TH√ÄNH T·∫§T C·∫¢ BATTLEPASS!")
                    LocalPlayer:Kick("Ho√†n th√†nh t·∫•t c·∫£ BattlePass!")
                end
            end
        end
        
        lastXP = currentXP
        lastLevel = currentLevel
    end
end

-- ========== KH·ªûI CH·∫†Y ========== --
local function main()
    loadProgress()
    
    -- K√≠ch ho·∫°t BattlePass ƒë·∫ßu ti√™n
    local nextBP, nextDisplay = getNextBattlePass()
    if nextBP then
        if activateBattlePass(nextBP) then
            -- G·ª≠i th√¥ng b√°o kh·ªüi ƒë·ªông
            local startMsg = "üöÄ B·∫ÆT ƒê·∫¶U THEO D√ïI BATTLEPASS\n"
            for _, bp in ipairs(BATTLE_PASSES) do
                startMsg = startMsg .. string.format("%s: %d/%d\n", bp.display, progress[bp.remote], XP_LIMIT)
            end
            startMsg = startMsg .. string.format("\nüîõ ƒêANG K√çCH HO·∫†T: %s", nextDisplay)
            sendToDiscord(startMsg)
            
            -- ƒê·∫∑t gi√° tr·ªã ban ƒë·∫ßu
            isFirstCheck = true
        else
            warn("Kh√¥ng th·ªÉ k√≠ch ho·∫°t BattlePass ban ƒë·∫ßu")
            return
        end
    else
        sendToDiscord("üéñÔ∏è T·∫§T C·∫¢ BATTLEPASS ƒê√É HO√ÄN TH√ÄNH!")
        return
    end
    
    -- V√≤ng l·∫∑p ki·ªÉm tra
    while wait(5) do
        if allMaxed() then break end
        checkProgress()
    end
end

-- Ch·∫°y ch∆∞∆°ng tr√¨nh
local success, err = pcall(main)
if not success then
    warn("L·ªói ch√≠nh:", err)
    sendToDiscord("‚ùå L·ªñI NGHI√äM TR·ªåNG: "..tostring(err))
end
