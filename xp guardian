-- Cáº¥u hÃ¬nh
local WEBHOOK_URL = "https://discord.com/api/webhooks/972059328276201492/DPHtxfsIldI5lND2dYUbA8WIZwp4NLYsPDG1Sy6-MKV9YMgV8OohcTf-00SdLmyMpMFC"
local XP_LIMIT = 10000
local SAVE_FILE = "BattlePassProgress.txt"

-- Mapping giá»¯a tÃªn hiá»ƒn thá»‹ vÃ  remote
local BATTLE_PASS_MAPPING = {
    ["HALLOWEEN 2024"] = {remote = "HW24"},
    ["TOWER BATTLES"] = {remote = "TB"},
    ["CHRISTMAS 2024"] = {remote = "XMAS24"}
}

-- Khá»Ÿi táº¡o dá»‹ch vá»¥
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

-- Biáº¿n lÆ°u trá»¯
local progress = {}
local currentBP = nil
local initialXP = 0
local lastXP = 0
local lastLevel = 0

-- HÃ m lÆ°u dá»¯ liá»‡u cá»±c ká»³ cháº¯c cháº¯n
local function superSaveProgress()
    -- Táº¡o báº£n sao dá»± phÃ²ng trÆ°á»›c khi lÆ°u
    local backupData = {}
    if isfile(SAVE_FILE) then
        backupData = HttpService:JSONDecode(readfile(SAVE_FILE)) or {}
    end
    
    -- LÆ°u dá»¯ liá»‡u má»›i vá»›i cÆ¡ cháº¿ retry
    local attempts = 0
    local maxAttempts = 3
    local saved = false
    
    repeat
        attempts = attempts + 1
        local success, err = pcall(function()
            -- Táº¡o file táº¡m trÆ°á»›c
            writefile(SAVE_FILE..".tmp", HttpService:JSONEncode(progress))
            -- Kiá»ƒm tra tÃ­nh toÃ n váº¹n
            local check = HttpService:JSONDecode(readfile(SAVE_FILE..".tmp"))
            if check then
                -- Náº¿u ok thÃ¬ Ä‘á»•i tÃªn thÃ nh file chÃ­nh thá»©c
                if isfile(SAVE_FILE) then
                    delfile(SAVE_FILE)
                end
                writefile(SAVE_FILE, readfile(SAVE_FILE..".tmp"))
                delfile(SAVE_FILE..".tmp")
                saved = true
            end
        end)
        
        if not success and attempts >= maxAttempts then
            -- KhÃ´i phá»¥c tá»« backup náº¿u lá»—i
            pcall(function()
                writefile(SAVE_FILE, HttpService:JSONEncode(backupData))
            end)
            warn("LÆ°u file tháº¥t báº¡i sau", maxAttempts, "láº§n thá»­")
            break
        end
        wait(0.5)
    until saved or attempts >= maxAttempts
end

-- HÃ m táº£i dá»¯ liá»‡u vá»›i kiá»ƒm tra nghiÃªm ngáº·t
local function superLoadProgress()
    if not isfile(SAVE_FILE) then
        -- Khá»Ÿi táº¡o má»›i náº¿u file khÃ´ng tá»“n táº¡i
        for _, mapping in pairs(BATTLE_PASS_MAPPING) do
            progress[mapping.remote] = 0
        end
        superSaveProgress()
        return
    end
    
    -- Äá»c file vá»›i cÆ¡ cháº¿ phá»¥c há»“i náº¿u cÃ³ lá»—i
    local content, success = nil, false
    local attempts = 0
    
    repeat
        attempts = attempts + 1
        content, success = pcall(function()
            return readfile(SAVE_FILE)
        end)
        
        if not success and attempts >= 3 then
            -- Táº¡o file má»›i náº¿u khÃ´ng Ä‘á»c Ä‘Æ°á»£c
            warn("KhÃ´ng thá»ƒ Ä‘á»c file, táº¡o má»›i...")
            for _, mapping in pairs(BATTLE_PASS_MAPPING) do
                progress[mapping.remote] = 0
            end
            superSaveProgress()
            return
        end
        wait(0.5)
    until success or attempts >= 3
    
    -- Kiá»ƒm tra dá»¯ liá»‡u há»£p lá»‡
    local ok, data = pcall(function()
        return HttpService:JSONDecode(content)
    end)
    
    if ok and type(data) == "table" then
        progress = data
        -- Äáº£m báº£o cÃ³ Ä‘á»§ táº¥t cáº£ BattlePass
        for _, mapping in pairs(BATTLE_PASS_MAPPING) do
            if progress[mapping.remote] == nil then
                progress[mapping.remote] = 0
            end
        end
    else
        -- Khá»Ÿi táº¡o láº¡i náº¿u dá»¯ liá»‡u khÃ´ng há»£p lá»‡
        warn("Dá»¯ liá»‡u file khÃ´ng há»£p lá»‡, táº¡o má»›i...")
        for _, mapping in pairs(BATTLE_PASS_MAPPING) do
            progress[mapping.remote] = 0
        end
    end
    
    superSaveProgress() -- Ghi láº¡i Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh toÃ n váº¹n
end

-- HÃ m láº¥y tÃªn hiá»ƒn thá»‹ BattlePass hiá»‡n táº¡i
local function getCurrentDisplayName()
    local success, displayName = pcall(function()
        return LocalPlayer.PlayerGui.GUI.BattlePass.BattlePassDetails.PreviewInfo.DisplayName.Text
    end)
    return success and displayName or nil
end

-- HÃ m kiá»ƒm tra vÃ  cáº­p nháº­t tráº¡ng thÃ¡i
local function checkAndUpdate()
    local currentXP, currentLevel = getCurrentXP()
    local displayName = getCurrentDisplayName()
    
    if not displayName then
        warn("KhÃ´ng thá»ƒ xÃ¡c Ä‘á»‹nh BattlePass hiá»‡n táº¡i!")
        return
    end
    
    local mapping = BATTLE_PASS_MAPPING[displayName]
    if not mapping then
        warn("KhÃ´ng tÃ¬m tháº¥y mapping cho:", displayName)
        return
    end
    
    if currentXP ~= lastXP then
        local xpGained = currentXP - lastXP
        if xpGained > 0 then
            progress[mapping.remote] = math.min(progress[mapping.remote] + xpGained, XP_LIMIT)
            superSaveProgress() -- LÆ°u ngay sau má»—i láº§n cáº­p nháº­t
            
            -- Gá»­i thÃ´ng bÃ¡o Discord
            sendToDiscord(string.format(
                "ğŸ¯ %s: +%d XP (Tá»•ng: %d/%d)\nLevel: %d",
                displayName, xpGained, progress[mapping.remote], XP_LIMIT, currentLevel
            ))
            
            -- Kiá»ƒm tra náº¿u Ä‘áº¡t giá»›i háº¡n
            if progress[mapping.remote] >= XP_LIMIT then
                local nextRemote, nextDisplay = getNextBattlePass()
                if nextRemote then
                    activateBattlePass(nextRemote)
                    sendToDiscord("ğŸ”„ CHUYá»‚N SANG: "..nextDisplay)
                else
                    sendToDiscord("ğŸ HOÃ€N THÃ€NH Táº¤T Cáº¢ BATTLEPASS!")
                    LocalPlayer:Kick("ÄÃ£ hoÃ n thÃ nh táº¥t cáº£!")
                end
            end
        end
        lastXP = currentXP
        lastLevel = currentLevel
    end
end

-- HÃ m chÃ­nh
local function main()
    superLoadProgress() -- Táº£i dá»¯ liá»‡u vá»›i cÆ¡ cháº¿ an toÃ n
    
    -- KÃ­ch hoáº¡t BattlePass Ä‘áº§u tiÃªn
    local nextRemote, nextDisplay = getNextBattlePass()
    if nextRemote then
        activateBattlePass(nextRemote)
        lastXP, lastLevel = getCurrentXP()
        sendToDiscord("ğŸš€ Báº¯t Ä‘áº§u theo dÃµi: "..nextDisplay)
    else
        sendToDiscord("ğŸ–ï¸ Táº¥t cáº£ BattlePass Ä‘Ã£ hoÃ n thÃ nh!")
        return
    end
    
    -- VÃ²ng láº·p kiá»ƒm tra
    while wait(1) do
        if allMaxed() then break end
        checkAndUpdate()
    end
end

-- Cháº¡y chÆ°Æ¡ng trÃ¬nh
local success, err = pcall(main)
if not success then
    warn("Lá»—i chÃ­nh:", err)
    sendToDiscord("âŒ Lá»–I NGHIÃŠM TRá»ŒNG: "..tostring(err))
end
