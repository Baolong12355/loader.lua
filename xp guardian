-- Cáº¥u hÃ¬nh
local WEBHOOK_URL = "https://discord.com/api/webhooks/972059328276201492/DPHtxfsIldI5lND2dYUbA8WIZwp4NLYsPDG1Sy6-MKV9YMgV8OohcTf-00SdLmyMpMFC"
local XP_LIMIT = 10000
local SAVE_FILE = "BattlePassProgress.txt"

-- Danh sÃ¡ch BattlePass
local BATTLE_PASSES = {
    {remote = "TB", display = "TOWER BATTLES"},
    {remote = "HW24", display = "HALLOWEEN 2024"}, 
    {remote = "XMAS24", display = "CHRISTMAS 2024"}
}

-- Khá»Ÿi táº¡o dá»‹ch vá»¥
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

-- KÃ­ch hoáº¡t HttpService náº¿u chÆ°a
if not HttpService:GetHttpEnabled() then
    HttpService:SetHttpEnabled(true)
end

-- Biáº¿n lÆ°u trá»¯
local progress = {}
local currentBP = nil
local lastXP = 0
local lastLevel = 0
local isFirstCheck = true

-- ========== Há»† THá»NG LÆ¯U FILE ========== --
local function saveProgress()
    local data = {}
    for _, bp in ipairs(BATTLE_PASSES) do
        data[bp.remote] = progress[bp.remote] or 0
    end
    writefile(SAVE_FILE, HttpService:JSONEncode(data))
end

local function loadProgress()
    if isfile(SAVE_FILE) then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile(SAVE_FILE))
        end)
        if success then
            for _, bp in ipairs(BATTLE_PASSES) do
                progress[bp.remote] = data[bp.remote] or 0
            end
            return
        end
    end
    
    -- Khá»Ÿi táº¡o má»›i
    for _, bp in ipairs(BATTLE_PASSES) do
        progress[bp.remote] = 0
    end
end

-- ========== Há»† THá»NG DISCORD ========== --
local function sendToDiscord(message)
    local data = {
        ["content"] = message,
        ["username"] = "BP Tracker",
        ["avatar_url"] = "https://i.imgur.com/Lyq5mJO.png"
    }
    
    -- ThÃªm retry mechanism
    local attempts = 0
    local maxAttempts = 3
    local success = false
    
    repeat
        attempts = attempts + 1
        success = pcall(function()
            local jsonData = HttpService:JSONEncode(data)
            HttpService:PostAsync(WEBHOOK_URL, jsonData)
        end)
        
        if not success then
            warn("Lá»—i gá»­i Discord (láº§n "..attempts..")")
            wait(2)
        end
    until success or attempts >= maxAttempts
    
    return success
end

-- ========== Há»† THá»NG THEO DÃ•I ========== --
local function getCurrentXP()
    local success, xpText = pcall(function()
        return LocalPlayer.PlayerGui.GUI.BattlePass.BattlePassDetails.LevelInfo.XP.TextLabel.Text
    end)
    return (success and tonumber(xpText:match("%d+"))) or 0
end

local function getCurrentLevel()
    local success, levelText = pcall(function()
        return LocalPlayer.PlayerGui.Model.GUI.BattlePass.BattlePassDetails.LevelInfo.Current.TextLabel.Text
    end)
    return (success and tonumber(levelText:match("%d+"))) or 0
end

local function getCurrentBattlePass()
    local success, displayName = pcall(function()
        return LocalPlayer.PlayerGui.GUI.BattlePass.BattlePassDetails.PreviewInfo.DisplayName.Text
    end)
    if success then
        for _, bp in ipairs(BATTLE_PASSES) do
            if bp.display == displayName then
                return bp.remote, bp.display
            end
        end
    end
    return nil, nil
end

-- ========== Há»† THá»NG Äá»”I BATTLEPASS ========== --
local function activateBattlePass(bpName)
    local network = ReplicatedStorage:FindFirstChild("Network")
    if not network then return false end
    
    local remote = network:FindFirstChild("BattlePassRequestActivate")
    if not remote then return false end
    
    local success, result = pcall(function()
        return remote:InvokeServer(bpName)
    end)
    
    return success and result or false
end

-- ========== Há»† THá»NG Tá»° Äá»˜NG ========== --
local function getNextBattlePass()
    for _, bp in ipairs(BATTLE_PASSES) do
        if progress[bp.remote] < XP_LIMIT then
            return bp.remote, bp.display
        end
    end
    return nil, nil
end

local function allMaxed()
    for _, bp in ipairs(BATTLE_PASSES) do
        if progress[bp.remote] < XP_LIMIT then
            return false
        end
    end
    return true
end

local function checkProgress()
    local currentXP = getCurrentXP()
    local currentLevel = getCurrentLevel()
    local bpRemote, bpDisplay = getCurrentBattlePass()
    
    if not bpRemote then 
        warn("KhÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c BattlePass hiá»‡n táº¡i")
        return 
    end
    
    -- Bá» qua láº§n kiá»ƒm tra Ä‘áº§u tiÃªn
    if isFirstCheck then
        lastXP = currentXP
        lastLevel = currentLevel
        isFirstCheck = false
        return
    end
    
    -- Chá»‰ xá»­ lÃ½ khi XP thay Ä‘á»•i
    if currentXP ~= lastXP then
        local xpGained = currentXP - lastXP
        
        if xpGained > 0 then
            progress[bpRemote] = math.min(progress[bpRemote] + xpGained, XP_LIMIT)
            saveProgress()
            
            -- Gá»­i thÃ´ng bÃ¡o Discord (cÃ³ kiá»ƒm tra)
            local message = string.format(
                "ğŸ¯ %s: +%d XP (Tá»•ng: %d/%d)\nLevel: %d",
                bpDisplay, xpGained, progress[bpRemote], XP_LIMIT, currentLevel
            )
            local discordSuccess = sendToDiscord(message)
            
            if not discordSuccess then
                warn("KhÃ´ng thá»ƒ gá»­i thÃ´ng bÃ¡o Discord")
            end
            
            -- Kiá»ƒm tra hoÃ n thÃ nh
            if progress[bpRemote] >= XP_LIMIT then
                sendToDiscord(string.format("âœ… ÄÃ£ Ä‘áº¡t Ä‘á»§ %d XP cho %s!", XP_LIMIT, bpDisplay))
                
                -- Chuyá»ƒn sang BattlePass tiáº¿p theo
                local nextBP, nextDisplay = getNextBattlePass()
                if nextBP then
                    if activateBattlePass(nextBP) then
                        sendToDiscord("ğŸ”„ ÄÃ£ chuyá»ƒn sang: "..nextDisplay)
                        isFirstCheck = true
                    end
                else
                    sendToDiscord("ğŸ† ÄÃƒ HOÃ€N THÃ€NH Táº¤T Cáº¢ BATTLEPASS!")
                    LocalPlayer:Kick("HoÃ n thÃ nh táº¥t cáº£ BattlePass!")
                end
            end
        end
        
        lastXP = currentXP
        lastLevel = currentLevel
    end
end

-- ========== KHá»I CHáº Y ========== --
local function main()
    -- Test Discord trÆ°á»›c
    if not sendToDiscord("ğŸŸ¢ Script BattlePass Tracker Ä‘Ã£ khá»Ÿi Ä‘á»™ng") then
        warn("KhÃ´ng thá»ƒ káº¿t ná»‘i vá»›i Discord, kiá»ƒm tra láº¡i WEBHOOK_URL")
        return
    end
    
    loadProgress()
    
    -- KÃ­ch hoáº¡t BattlePass Ä‘áº§u tiÃªn
    local nextBP, nextDisplay = getNextBattlePass()
    if nextBP then
        if activateBattlePass(nextBP) then
            local startMsg = "ğŸš€ Báº®T Äáº¦U THEO DÃ•I BATTLEPASS\n"
            for _, bp in ipairs(BATTLE_PASSES) do
                startMsg = startMsg .. string.format("%s: %d/%d\n", bp.display, progress[bp.remote], XP_LIMIT)
            end
            startMsg = startMsg .. string.format("\nğŸ”› ÄANG KÃCH HOáº T: %s", nextDisplay)
            sendToDiscord(startMsg)
            
            isFirstCheck = true
        else
            sendToDiscord("âŒ KhÃ´ng thá»ƒ kÃ­ch hoáº¡t BattlePass ban Ä‘áº§u!")
            return
        end
    else
        sendToDiscord("ğŸ–ï¸ Táº¤T Cáº¢ BATTLEPASS ÄÃƒ HOÃ€N THÃ€NH!")
        return
    end
    
    -- VÃ²ng láº·p kiá»ƒm tra
    while wait(5) do
        if allMaxed() then break end
        checkProgress()
    end
end

-- Cháº¡y chÆ°Æ¡ng trÃ¬nh
local success, err = pcall(main)
if not success then
    warn("Lá»—i chÃ­nh:", err)
    sendToDiscord("âŒ Lá»–I NGHIÃŠM TRá»ŒNG: "..tostring(err))
end
