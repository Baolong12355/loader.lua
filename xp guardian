-- C·∫•u h√¨nh
local WEBHOOK_URL = "https://discord.com/api/webhooks/972059328276201492/DPHtxfsIldI5lND2dYUbA8WIZwp4NLYsPDG1Sy6-MKV9YMgV8OohcTf-00SdLmyMpMFC"
local XP_LIMIT = 10000
local SAVE_FILE = "BattlePassProgress.txt"

local BATTLE_PASSES = {
    {remote = "TB", display = "TOWER BATTLES"},
    {remote = "HW24", display = "HALLOWEEN 2024"},
    {remote = "XMAS24", display = "CHRISTMAS 2024"},
}

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

-- G·ª≠i Discord b·∫±ng request (executor h·ªó tr·ª£ ƒë·∫ßy ƒë·ªß)
local function sendToDiscord(message)
    local data = {
        content = message,
        username = "BP Tracker",
        avatar_url = "https://i.imgur.com/Lyq5mJO.png"
    }

    local encoded = HttpService:JSONEncode(data)
    local request = (syn and syn.request) or (http and http.request) or (request) or http_request

    if request then
        local ok, res = pcall(function()
            return request({
                Url = WEBHOOK_URL,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json"
                },
                Body = encoded
            })
        end)
        if ok and res and res.StatusCode < 300 then
            return true
        else
            warn("‚ùå L·ªói g·ª≠i Discord:", res and res.StatusCode)
        end
    else
        warn("‚ùå Executor kh√¥ng h·ªó tr·ª£ request HTTP")
    end
    return false
end

-- Bi·∫øn tr·∫°ng th√°i
local progress = {}
local lastXP = 0
local lastLevel = 0
local isFirstCheck = true

-- L∆∞u/ƒë·ªçc ti·∫øn tr√¨nh
local function saveProgress()
    local data = {}
    for _, bp in ipairs(BATTLE_PASSES) do
        data[bp.remote] = progress[bp.remote] or 0
    end
    writefile(SAVE_FILE, HttpService:JSONEncode(data))
end

local function loadProgress()
    if isfile(SAVE_FILE) then
        local ok, data = pcall(function()
            return HttpService:JSONDecode(readfile(SAVE_FILE))
        end)
        if ok then
            for _, bp in ipairs(BATTLE_PASSES) do
                progress[bp.remote] = data[bp.remote] or 0
            end
            return
        end
    end
    for _, bp in ipairs(BATTLE_PASSES) do
        progress[bp.remote] = 0
    end
end

-- H√†m ƒë·ªçc GUI
local function getCurrentXP()
    local ok, xpText = pcall(function()
        return LocalPlayer.PlayerGui.GUI.BattlePass.BattlePassDetails.LevelInfo.XP.TextLabel.Text
    end)
    if ok and xpText then
        local num = tonumber(xpText:match("%d+"))
        return num or 0
    end
    return 0
end

local function getCurrentLevel()
    local ok, lvlText = pcall(function()
        return LocalPlayer.PlayerGui.Model.GUI.BattlePass.BattlePassDetails.LevelInfo.Current.TextLabel.Text
    end)
    if ok and lvlText then
        local num = tonumber(lvlText:match("%d+"))
        return num or 0
    end
    return 0
end

local function getCurrentBattlePass()
    local ok, name = pcall(function()
        return LocalPlayer.PlayerGui.GUI.BattlePass.BattlePassDetails.PreviewInfo.DisplayName.Text
    end)
    if ok and name then
        for _, bp in ipairs(BATTLE_PASSES) do
            if bp.display:lower() == name:lower() then
                return bp.remote, bp.display
            end
        end
    end
    return nil, nil
end

local function activateBattlePass(bpName)
    local remote = ReplicatedStorage:FindFirstChild("Network")
    if not remote then return false end
    local r = remote:FindFirstChild("BattlePassRequestActivate")
    if not r then return false end
    local ok, result = pcall(function()
        return r:InvokeServer(bpName)
    end)
    return ok and result or false
end

local function getNextBattlePass()
    for _, bp in ipairs(BATTLE_PASSES) do
        if (progress[bp.remote] or 0) < XP_LIMIT then
            return bp.remote, bp.display
        end
    end
    return nil, nil
end

local function allMaxed()
    for _, bp in ipairs(BATTLE_PASSES) do
        if (progress[bp.remote] or 0) < XP_LIMIT then
            return false
        end
    end
    return true
end

-- Theo d√µi ti·∫øn tr√¨nh
local function checkProgress()
    local currentXP = getCurrentXP()
    local currentLevel = getCurrentLevel()
    local bpRemote, bpDisplay = getCurrentBattlePass()

    if not bpRemote then
        warn("‚ùå Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c BattlePass hi·ªán t·∫°i.")
        return
    end

    progress[bpRemote] = progress[bpRemote] or 0

    if isFirstCheck then
        lastXP = currentXP
        lastLevel = currentLevel
        isFirstCheck = false
        return
    end

    local xpGained = currentXP - lastXP
    if xpGained > 0 then
        progress[bpRemote] = math.min(progress[bpRemote] + xpGained, XP_LIMIT)
        saveProgress()

        sendToDiscord(string.format(
            "üéØ %s: +%d XP (T·ªïng: %d/%d)\nLevel: %d",
            bpDisplay, xpGained, progress[bpRemote], XP_LIMIT, currentLevel
        ))

        if progress[bpRemote] >= XP_LIMIT then
            sendToDiscord(string.format("‚úÖ ƒê√£ ho√†n th√†nh %s!", bpDisplay))
            local next, nextName = getNextBattlePass()
            if next then
                if activateBattlePass(next) then
                    sendToDiscord("üîÑ Chuy·ªÉn sang BattlePass: " .. nextName)
                    isFirstCheck = true
                end
            else
                sendToDiscord("üèÅ ƒê√É HO√ÄN TH√ÄNH T·∫§T C·∫¢ BATTLEPASS!")
                LocalPlayer:Kick("ƒê√£ ho√†n th√†nh to√†n b·ªô BattlePass.")
            end
        end
    end

    lastXP = currentXP
    lastLevel = currentLevel
end

-- Main
local function main()
    sendToDiscord("üü¢ Script BattlePass Tracker ƒë√£ kh·ªüi ƒë·ªông!")
    loadProgress()

    local next, name = getNextBattlePass()
    if next and activateBattlePass(next) then
        local msg = "üöÄ B·∫ÆT ƒê·∫¶U THEO D√ïI:\n"
        for _, bp in ipairs(BATTLE_PASSES) do
            msg = msg .. string.format("%s: %d/%d\n", bp.display, progress[bp.remote] or 0, XP_LIMIT)
        end
        msg = msg .. "üîõ ƒêANG K√çCH HO·∫†T: " .. name
        sendToDiscord(msg)
        isFirstCheck = true
    else
        sendToDiscord("üéñÔ∏è T·∫§T C·∫¢ BATTLEPASS ƒê√É HO√ÄN TH√ÄNH!")
        return
    end

    while task.wait(5) do
        if allMaxed() then break end
        checkProgress()
    end
end

-- B·∫Øt ƒë·∫ßu script
local ok, err = pcall(main)
if not ok then
    warn("‚ùå L·ªói nghi√™m tr·ªçng:", err)
    sendToDiscord("üí• L·ªói nghi√™m tr·ªçng: " .. tostring(err))
end
