-- Formation Manager Script - Tá»± Ä‘á»™ng lÆ°u vÃ  rebuild Ä‘á»™i hÃ¬nh
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local cashStat = player:WaitForChild("leaderstats"):WaitForChild("Cash")
local Remotes = ReplicatedStorage:WaitForChild("Remotes")

-- File paths
local formationFile = "tdx/formation.json"
local tempFile = "tdx/temp_formation.json"

-- Táº¡o thÆ° má»¥c náº¿u chÆ°a cÃ³
if makefolder then
    pcall(function() makefolder("tdx") end)
end

-- Safe Require
local function SafeRequire(path, timeout)
    timeout = timeout or 5
    local t0 = os.clock()
    while os.clock() - t0 < timeout do
        local success, result = pcall(function()
            return require(path)
        end)
        if success then return result end
        task.wait()
    end
    return nil
end

-- Load TowerClass
local function LoadTowerClass()
    local ps = player:WaitForChild("PlayerScripts")
    local client = ps:WaitForChild("Client")
    local gameClass = client:WaitForChild("GameClass")
    local towerModule = gameClass:WaitForChild("TowerClass")
    return SafeRequire(towerModule)
end

local TowerClass = LoadTowerClass()
if not TowerClass then error("KhÃ´ng thá»ƒ táº£i TowerClass") end

-- Láº¥y thÃ´ng tin tower tá»« GUI
local function GetTowerPlaceCostByName(name)
    local playerGui = player:FindFirstChild("PlayerGui")
    if not playerGui then return 0 end
    local interface = playerGui:FindFirstChild("Interface")
    if not interface then return 0 end
    local bottomBar = interface:FindFirstChild("BottomBar")
    if not bottomBar then return 0 end
    local towersBar = bottomBar:FindFirstChild("TowersBar")
    if not towersBar then return 0 end
    
    for _, tower in ipairs(towersBar:GetChildren()) do
        if tower.Name == name then
            local costFrame = tower:FindFirstChild("CostFrame")
            local costText = costFrame and costFrame:FindFirstChild("CostText")
            if costText then
                local raw = tostring(costText.Text):gsub("%D", "")
                return tonumber(raw) or 0
            end
        end
    end
    return 0
end

-- Láº¥y thÃ´ng tin Ä‘áº§y Ä‘á»§ cá»§a tower
local function GetTowerInfo(hash, tower)
    local success, result = pcall(function()
        local model = tower.Character:GetCharacterModel()
        local root = model and (model.PrimaryPart or model:FindFirstChild("HumanoidRootPart"))
        if not root then return nil end
        
        local pos = root.Position
        local hp = tower.HealthHandler and tower.HealthHandler:GetHealth() or 0
        if hp <= 0 then return nil end
        
        -- Láº¥y thÃ´ng tin level
        local levels = {}
        if tower.LevelHandler then
            for path = 1, 3 do
                levels[path] = tower.LevelHandler:GetLevelOnPath(path) or 0
            end
        end
        
        -- Láº¥y target type
        local targetType = 1
        if tower.TargetHandler then
            targetType = tower.TargetHandler:GetQueryType() or 1
        end
        
        return {
            hash = hash,
            name = tower.Name,
            position = {x = pos.X, y = pos.Y, z = pos.Z},
            levels = levels,
            targetType = targetType,
            placeCost = GetTowerPlaceCostByName(tower.Name)
        }
    end)
    
    return success and result or nil
end

-- LÆ°u Ä‘á»™i hÃ¬nh hiá»‡n táº¡i
local function SaveCurrentFormation()
    local formation = {}
    
    for hash, tower in pairs(TowerClass.GetTowers()) do
        local info = GetTowerInfo(hash, tower)
        if info then
            table.insert(formation, info)
        end
    end
    
    -- Sáº¯p xáº¿p theo vá»‹ trÃ­ X Ä‘á»ƒ dá»… Ä‘á»c
    table.sort(formation, function(a, b)
        return a.position.x < b.position.x
    end)
    
    local jsonData = HttpService:JSONEncode(formation)
    writefile(formationFile, jsonData)
    
    print("âœ… ÄÃ£ lÆ°u Ä‘á»™i hÃ¬nh vá»›i " .. #formation .. " tower(s)")
    return formation
end

-- Cáº­p nháº­t thÃ´ng tin tower trong file
local function UpdateTowerInFormation(hash, updateData)
    if not isfile(formationFile) then return end
    
    local success, formation = pcall(function()
        return HttpService:JSONDecode(readfile(formationFile))
    end)
    
    if not success then return end
    
    for i, towerData in ipairs(formation) do
        if towerData.hash == hash then
            -- Cáº­p nháº­t thÃ´ng tin
            for key, value in pairs(updateData) do
                towerData[key] = value
            end
            
            -- LÆ°u láº¡i file
            local jsonData = HttpService:JSONEncode(formation)
            writefile(formationFile, jsonData)
            print("ğŸ”„ Cáº­p nháº­t tower:", towerData.name, "táº¡i X =", towerData.position.x)
            return
        end
    end
end

-- XÃ³a tower khá»i file
local function RemoveTowerFromFormation(hash)
    if not isfile(formationFile) then return end
    
    local success, formation = pcall(function()
        return HttpService:JSONDecode(readfile(formationFile))
    end)
    
    if not success then return end
    
    for i = #formation, 1, -1 do
        if formation[i].hash == hash then
            local towerName = formation[i].name
            local towerX = formation[i].position.x
            table.remove(formation, i)
            
            -- LÆ°u láº¡i file
            local jsonData = HttpService:JSONEncode(formation)
            writefile(formationFile, jsonData)
            print("ğŸ—‘ï¸ XÃ³a tower:", towerName, "táº¡i X =", towerX)
            return
        end
    end
end

-- TÃ¬m tower theo X
local function GetTowerByAxis(axisX)
    for hash, tower in pairs(TowerClass.GetTowers()) do
        local success, pos = pcall(function()
            local model = tower.Character:GetCharacterModel()
            local root = model and (model.PrimaryPart or model:FindFirstChild("HumanoidRootPart"))
            return root and root.Position
        end)
        if success and pos and math.abs(pos.X - axisX) <= 1 then
            local hp = tower.HealthHandler and tower.HealthHandler:GetHealth()
            if hp and hp > 0 then
                return hash, tower
            end
        end
    end
    return nil, nil
end

-- Chá» Ä‘á»§ tiá»n
local function WaitForCash(amount)
    while cashStat.Value < amount do task.wait() end
end

-- Äáº·t tower
local function PlaceTowerRetry(name, pos, rotation)
    local placeCost = GetTowerPlaceCostByName(name)
    WaitForCash(placeCost)
    
    local args = {1, name, pos, rotation or 0}
    
    while true do
        Remotes.PlaceTower:InvokeServer(unpack(args))
        local t0 = tick()
        repeat
            task.wait(0.1)
            local hash = GetTowerByAxis(pos.X)
            if hash then 
                print("âœ… ÄÃ£ Ä‘áº·t:", name, "táº¡i X =", pos.X)
                return hash
            end
        until tick() - t0 > 2
        warn("[RETRY] Äáº·t tower tháº¥t báº¡i, thá»­ láº¡i:", name, "X =", pos.X)
    end
end

-- NÃ¢ng cáº¥p tower
local function UpgradeTowerToLevel(axisX, targetLevels)
    local hash, tower = GetTowerByAxis(axisX)
    if not hash or not tower then return end
    
    for path = 1, 3 do
        local targetLevel = targetLevels[path] or 0
        if targetLevel > 0 then
            local currentLevel = tower.LevelHandler:GetLevelOnPath(path)
            
            for level = currentLevel + 1, targetLevel do
                local cost = tower.LevelHandler:GetLevelUpgradeCost(path, 1)
                if cost then
                    WaitForCash(cost)
                    Remotes.TowerUpgradeRequest:FireServer(hash, path, 1)
                    
                    -- Chá» nÃ¢ng cáº¥p hoÃ n thÃ nh
                    local upgraded = false
                    local t0 = tick()
                    repeat
                        task.wait(0.1)
                        local _, t = GetTowerByAxis(axisX)
                        if t and t.LevelHandler then
                            local after = t.LevelHandler:GetLevelOnPath(path)
                            if after >= level then 
                                upgraded = true 
                                break 
                            end
                        end
                    until tick() - t0 > 3
                    
                    if not upgraded then
                        warn("âŒ NÃ¢ng cáº¥p tháº¥t báº¡i:", path, "level", level)
                        break
                    end
                end
            end
        end
    end
end

-- Äá»•i target
local function ChangeTarget(axisX, targetType)
    local hash = GetTowerByAxis(axisX)
    if hash then
        Remotes.ChangeQueryType:FireServer(hash, targetType)
    end
end

-- Rebuild Ä‘á»™i hÃ¬nh
local function RebuildFormation()
    if not isfile(formationFile) then
        warn("âŒ KhÃ´ng tÃ¬m tháº¥y file Ä‘á»™i hÃ¬nh!")
        return
    end
    
    local success, formation = pcall(function()
        return HttpService:JSONDecode(readfile(formationFile))
    end)
    
    if not success then
        warn("âŒ Lá»—i khi Ä‘á»c file Ä‘á»™i hÃ¬nh!")
        return
    end
    
    print("ğŸ”„ Báº¯t Ä‘áº§u rebuild Ä‘á»™i hÃ¬nh vá»›i " .. #formation .. " tower(s)")
    
    -- Äáº·t towers
    for _, towerData in ipairs(formation) do
        local pos = Vector3.new(towerData.position.x, towerData.position.y, towerData.position.z)
        local hash = PlaceTowerRetry(towerData.name, pos, 0)
        
        if hash then
            -- Cáº­p nháº­t hash má»›i
            towerData.hash = hash
            
            -- NÃ¢ng cáº¥p
            if towerData.levels then
                UpgradeTowerToLevel(pos.X, towerData.levels)
            end
            
            -- Äá»•i target
            if towerData.targetType and towerData.targetType ~= 1 then
                ChangeTarget(pos.X, towerData.targetType)
            end
        end
    end
    
    -- LÆ°u láº¡i vá»›i hash má»›i
    local jsonData = HttpService:JSONEncode(formation)
    writefile(formationFile, jsonData)
    
    print("âœ… HoÃ n thÃ nh rebuild Ä‘á»™i hÃ¬nh!")
end

-- Láº¯ng nghe cÃ¡c Remote events Ä‘á»ƒ cáº­p nháº­t file
Remotes.TowerFactoryQueueUpdated.OnClientEvent:Connect(function(data)
    local d = data[1]
    if not d then return end
    
    if d.Creation then
        -- Tower Ä‘Æ°á»£c Ä‘áº·t - tá»± Ä‘á»™ng lÆ°u vÃ o formation
        task.wait(0.5) -- Chá» tower hoÃ n thÃ nh
        SaveCurrentFormation()
    else
        -- Tower bá»‹ bÃ¡n - xÃ³a khá»i formation
        task.wait(0.1)
        SaveCurrentFormation() -- LÆ°u láº¡i toÃ n bá»™ Ä‘á»ƒ Ä‘áº£m báº£o Ä‘á»“ng bá»™
    end
end)

Remotes.TowerUpgradeQueueUpdated.OnClientEvent:Connect(function(data)
    if data[1] then
        -- Tower Ä‘Æ°á»£c nÃ¢ng cáº¥p - cáº­p nháº­t formation
        task.wait(0.5)
        SaveCurrentFormation()
    end
end)

Remotes.TowerQueryTypeIndexChanged.OnClientEvent:Connect(function(data)
    if data[1] then
        -- Target type thay Ä‘á»•i - cáº­p nháº­t formation
        task.wait(0.1)
        SaveCurrentFormation()
    end
end)

-- Console commands
_G.rebuild = function()
    RebuildFormation()
end

_G.save = function()
    SaveCurrentFormation()
end

_G.clear = function()
    if isfile(formationFile) then
        delfile(formationFile)
        print("ğŸ—‘ï¸ ÄÃ£ xÃ³a file Ä‘á»™i hÃ¬nh")
    end
end

-- LÆ°u Ä‘á»™i hÃ¬nh ban Ä‘áº§u
task.wait(2)
SaveCurrentFormation()

print("ğŸ¯ Formation Manager Ä‘Ã£ khá»Ÿi Ä‘á»™ng!")
print("ğŸ“‹ Commands:")
print("  â€¢ rebuild() - Rebuild Ä‘á»™i hÃ¬nh tá»« file")
print("  â€¢ save() - LÆ°u Ä‘á»™i hÃ¬nh hiá»‡n táº¡i")
print("  â€¢ clear() - XÃ³a file Ä‘á»™i hÃ¬nh")
