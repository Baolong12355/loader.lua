-- Cấu hình
local WEBHOOK_URL = "https://discord.com/api/webhooks/972059328276201492/DPHtxfsIldI5lND2dYUbA8WIZwp4NLYsPDG1Sy6-MKV9YMgV8OohcTf-00SdLmyMpMFC"
local XP_LIMIT = 10000
local SAVE_FILE = "BattlePassProgress.txt"

-- Danh sách BattlePass
local BATTLE_PASSES = {
    {remote = "TB", display = "TOWER BATTLES"},
    {remote = "HW24", display = "HALLOWEEN 2024"}, 
    {remote = "XMAS24", display = "CHRISTMAS 2024"}
}

-- Khởi tạo dịch vụ
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

-- Kích hoạt HttpService nếu chưa
if not HttpService:GetHttpEnabled() then
    HttpService:SetHttpEnabled(true)
end

-- Biến lưu trữ
local progress = {}
local currentBP = nil
local lastXP = 0
local lastLevel = 0
local isFirstCheck = true

-- ========== HỆ THỐNG LƯU FILE ========== --
local function saveProgress()
    local data = {}
    for _, bp in ipairs(BATTLE_PASSES) do
        data[bp.remote] = progress[bp.remote] or 0
    end
    writefile(SAVE_FILE, HttpService:JSONEncode(data))
end

local function loadProgress()
    if isfile(SAVE_FILE) then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile(SAVE_FILE))
        end)
        if success then
            for _, bp in ipairs(BATTLE_PASSES) do
                progress[bp.remote] = data[bp.remote] or 0
            end
            return
        end
    end
    
    -- Khởi tạo mới
    for _, bp in ipairs(BATTLE_PASSES) do
        progress[bp.remote] = 0
    end
end

-- ========== HỆ THỐNG DISCORD ========== --
local function sendToDiscord(message)
    local data = {
        ["content"] = message,
        ["username"] = "BP Tracker",
        ["avatar_url"] = "https://i.imgur.com/Lyq5mJO.png"
    }
    
    -- Thêm retry mechanism
    local attempts = 0
    local maxAttempts = 3
    local success = false
    
    repeat
        attempts = attempts + 1
        success = pcall(function()
            local jsonData = HttpService:JSONEncode(data)
            HttpService:PostAsync(WEBHOOK_URL, jsonData)
        end)
        
        if not success then
            warn("Lỗi gửi Discord (lần "..attempts..")")
            wait(2)
        end
    until success or attempts >= maxAttempts
    
    return success
end

-- ========== HỆ THỐNG THEO DÕI ========== --
local function getCurrentXP()
    local success, xpText = pcall(function()
        return LocalPlayer.PlayerGui.GUI.BattlePass.BattlePassDetails.LevelInfo.XP.TextLabel.Text
    end)
    return (success and tonumber(xpText:match("%d+"))) or 0
end

local function getCurrentLevel()
    local success, levelText = pcall(function()
        return LocalPlayer.PlayerGui.Model.GUI.BattlePass.BattlePassDetails.LevelInfo.Current.TextLabel.Text
    end)
    return (success and tonumber(levelText:match("%d+"))) or 0
end

local function getCurrentBattlePass()
    local success, displayName = pcall(function()
        return LocalPlayer.PlayerGui.GUI.BattlePass.BattlePassDetails.PreviewInfo.DisplayName.Text
    end)
    if success then
        for _, bp in ipairs(BATTLE_PASSES) do
            if bp.display == displayName then
                return bp.remote, bp.display
            end
        end
    end
    return nil, nil
end

-- ========== HỆ THỐNG ĐỔI BATTLEPASS ========== --
local function activateBattlePass(bpName)
    local network = ReplicatedStorage:FindFirstChild("Network")
    if not network then return false end
    
    local remote = network:FindFirstChild("BattlePassRequestActivate")
    if not remote then return false end
    
    local success, result = pcall(function()
        return remote:InvokeServer(bpName)
    end)
    
    return success and result or false
end

-- ========== HỆ THỐNG TỰ ĐỘNG ========== --
local function getNextBattlePass()
    for _, bp in ipairs(BATTLE_PASSES) do
        if progress[bp.remote] < XP_LIMIT then
            return bp.remote, bp.display
        end
    end
    return nil, nil
end

local function allMaxed()
    for _, bp in ipairs(BATTLE_PASSES) do
        if progress[bp.remote] < XP_LIMIT then
            return false
        end
    end
    return true
end

local function checkProgress()
    local currentXP = getCurrentXP()
    local currentLevel = getCurrentLevel()
    local bpRemote, bpDisplay = getCurrentBattlePass()
    
    if not bpRemote then 
        warn("Không xác định được BattlePass hiện tại")
        return 
    end
    
    -- Bỏ qua lần kiểm tra đầu tiên
    if isFirstCheck then
        lastXP = currentXP
        lastLevel = currentLevel
        isFirstCheck = false
        return
    end
    
    -- Chỉ xử lý khi XP thay đổi
    if currentXP ~= lastXP then
        local xpGained = currentXP - lastXP
        
        if xpGained > 0 then
            progress[bpRemote] = math.min(progress[bpRemote] + xpGained, XP_LIMIT)
            saveProgress()
            
            -- Gửi thông báo Discord (có kiểm tra)
            local message = string.format(
                "🎯 %s: +%d XP (Tổng: %d/%d)\nLevel: %d",
                bpDisplay, xpGained, progress[bpRemote], XP_LIMIT, currentLevel
            )
            local discordSuccess = sendToDiscord(message)
            
            if not discordSuccess then
                warn("Không thể gửi thông báo Discord")
            end
            
            -- Kiểm tra hoàn thành
            if progress[bpRemote] >= XP_LIMIT then
                sendToDiscord(string.format("✅ Đã đạt đủ %d XP cho %s!", XP_LIMIT, bpDisplay))
                
                -- Chuyển sang BattlePass tiếp theo
                local nextBP, nextDisplay = getNextBattlePass()
                if nextBP then
                    if activateBattlePass(nextBP) then
                        sendToDiscord("🔄 Đã chuyển sang: "..nextDisplay)
                        isFirstCheck = true
                    end
                else
                    sendToDiscord("🏆 ĐÃ HOÀN THÀNH TẤT CẢ BATTLEPASS!")
                    LocalPlayer:Kick("Hoàn thành tất cả BattlePass!")
                end
            end
        end
        
        lastXP = currentXP
        lastLevel = currentLevel
    end
end

-- ========== KHỞI CHẠY ========== --
local function main()
    -- Test Discord trước
    if not sendToDiscord("🟢 Script BattlePass Tracker đã khởi động") then
        warn("Không thể kết nối với Discord, kiểm tra lại WEBHOOK_URL")
        return
    end
    
    loadProgress()
    
    -- Kích hoạt BattlePass đầu tiên
    local nextBP, nextDisplay = getNextBattlePass()
    if nextBP then
        if activateBattlePass(nextBP) then
            local startMsg = "🚀 BẮT ĐẦU THEO DÕI BATTLEPASS\n"
            for _, bp in ipairs(BATTLE_PASSES) do
                startMsg = startMsg .. string.format("%s: %d/%d\n", bp.display, progress[bp.remote], XP_LIMIT)
            end
            startMsg = startMsg .. string.format("\n🔛 ĐANG KÍCH HOẠT: %s", nextDisplay)
            sendToDiscord(startMsg)
            
            isFirstCheck = true
        else
            sendToDiscord("❌ Không thể kích hoạt BattlePass ban đầu!")
            return
        end
    else
        sendToDiscord("🎖️ TẤT CẢ BATTLEPASS ĐÃ HOÀN THÀNH!")
        return
    end
    
    -- Vòng lặp kiểm tra
    while wait(5) do
        if allMaxed() then break end
        checkProgress()
    end
end

-- Chạy chương trình
local success, err = pcall(main)
if not success then
    warn("Lỗi chính:", err)
    sendToDiscord("❌ LỖI NGHIÊM TRỌNG: "..tostring(err))
end
